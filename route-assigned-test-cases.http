### SIRHA API - Casos de Prueba de Auditoría ROUTE_ASSIGNED
### Pruebas para FEAT-022 US-0084: Audit Ruteo

@baseUrl = http://localhost:3000
@contentType = application/json

### ===========================================
### 1. AUDITORÍA AUTOMÁTICA ROUTE_ASSIGNED
### ===========================================

### 1.1 Crear solicitud con ruteo normal (mismo programa)
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a0",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a2",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a3",
  "reason": "Solicitud con ruteo normal - mismo programa CS"
}

### 1.2 Crear solicitud con diferentes programas
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a2",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a4",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a5",
  "reason": "Solicitud con diferentes programas - CS a MAT"
}

### 1.3 Crear solicitud que active fallback
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1ax",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1ay",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1az",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1aw",
  "reason": "Solicitud que activará fallback - materias sin programa"
}

### 1.4 Crear solicitud con programa del estudiante
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a6",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a7",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1ay",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1az",
  "reason": "Solicitud mixta - solo origen con programa FIS"
}

### ===========================================
### 2. AUDITORÍA MANUAL ROUTE_ASSIGNED
### ===========================================

### 2.1 Registrar evento ROUTE_ASSIGNED manualmente
POST {{baseUrl}}/route-assigned-examples/manual-route-assigned
Content-Type: {{contentType}}

### 2.2 Segundo evento manual con diferentes parámetros
POST {{baseUrl}}/route-assigned-examples/manual-route-assigned
Content-Type: {{contentType}}

### ===========================================
### 3. CONSULTAS DE EVENTOS ROUTE_ASSIGNED
### ===========================================

### 3.1 Obtener todos los eventos ROUTE_ASSIGNED
GET {{baseUrl}}/route-assigned-examples/route-assigned-events

### 3.2 Obtener información de troubleshooting específica
GET {{baseUrl}}/route-assigned-examples/troubleshooting-info/manual-route-assigned-123

### 3.3 Obtener troubleshooting de solicitud real (usar ID de respuesta anterior)
GET {{baseUrl}}/route-assigned-examples/troubleshooting-info/REPLACE_WITH_ACTUAL_REQUEST_ID

### ===========================================
### 4. CASOS ESPECÍFICOS DE RUTEO
### ===========================================

### 4.1 Ruteo ING a ADMIN (diferentes programas)
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a3",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a4",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a9",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1aa",
  "reason": "Ruteo ING a ADMIN - debe usar programa destino"
}

### 4.2 Ruteo MAT a MAT (mismo programa)
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a4",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a5",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a5",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a6",
  "reason": "Ruteo MAT a MAT - mismo programa"
}

### 4.3 Ruteo FIS a CS (diferentes programas)
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a7",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a8",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a0",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "reason": "Ruteo FIS a CS - debe usar programa destino CS"
}

### ===========================================
### 5. VERIFICACIÓN DE INFORMACIÓN COMPLETA
### ===========================================

### 5.1 Crear solicitud y verificar datos completos
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a8",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a9",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1aa",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1ab",
  "reason": "Verificación completa de datos ROUTE_ASSIGNED"
}

### 5.2 Obtener troubleshooting de la solicitud anterior
### (Usar el ID retornado en la respuesta anterior)
GET {{baseUrl}}/route-assigned-examples/troubleshooting-info/REPLACE_WITH_ACTUAL_ID

### ===========================================
### 6. INTEGRACIÓN CON OTROS EVENTOS
### ===========================================

### 6.1 Crear solicitud normal y verificar todos los eventos
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a2",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a3",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a6",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a7",
  "reason": "Solicitud para verificar integración completa"
}

### 6.2 Verificar historial completo de auditoría
GET {{baseUrl}}/audit-examples/history/REPLACE_WITH_ACTUAL_REQUEST_ID

### ===========================================
### 7. CASOS EDGE PARA TROUBLESHOOTING
### ===========================================

### 7.1 Materias con IDs especiales
POST {{baseUrl}}/route-assigned-examples/create-with-route-audit
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a0",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a9",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1aa",
  "reason": "Caso edge - CS a ADMIN para troubleshooting"
}

### 7.2 Obtener información detallada para análisis
GET {{baseUrl}}/route-assigned-examples/troubleshooting-info/REPLACE_WITH_ACTUAL_ID

### 7.3 Verificar eventos ROUTE_ASSIGNED recientes
GET {{baseUrl}}/route-assigned-examples/route-assigned-events

### ===========================================
### NOTAS DE PRUEBA:
### 
### Criterios de aceptación verificados:
### ✅ Evento ROUTE_ASSIGNED se registra automáticamente
### ✅ Incluye programa y criterio de asignación
### ✅ Información suficiente para troubleshooting
### 
### Información registrada en ROUTE_ASSIGNED:
### - finalProgramId: Programa finalmente asignado
### - routingDecision: Decisión original del ruteo
###   - originalRule: Regla aplicada (SAME_PROGRAM, TARGET_PROGRAM, etc.)
###   - originalReason: Razón de la decisión
###   - originalProgramId: Programa propuesto inicialmente
### - validationResult: Resultado de la validación
###   - validationPassed: Si pasó la validación
###   - fallbackUsed: Si se usó fallback
###   - fallbackReason: Razón del fallback
###   - finalProgramId: Programa final después de validación
### - troubleshootingInfo: Información completa para debugging
###   - userId, sourceSubjectId, targetSubjectId
###   - sourceSubjectProgram, targetSubjectProgram
###   - studentProgramId, radicado, priority
###   - routingTimestamp
### 
### Flujo completo auditado:
### 1. CREATE: Solicitud creada
### 2. RADICATE: Radicado asignado
### 3. ROUTE: Decisión de ruteo inicial
### 4. FALLBACK: Si se usó fallback (opcional)
### 5. ROUTE_ASSIGNED: Asignación final con información completa
### 
### Casos de troubleshooting cubiertos:
### - ¿Qué regla se aplicó inicialmente?
### - ¿Por qué se asignó este programa?
### - ¿Se usó fallback? ¿Por qué?
### - ¿Cuáles eran los programas de las materias?
### - ¿Cuál era el programa del estudiante?
### - ¿Cuándo se tomó la decisión?
### - ¿Cuál fue el resultado final?
### ===========================================