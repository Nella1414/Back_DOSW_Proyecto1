### SIRHA API - Casos de Prueba de Solicitudes de Cambio
### Pruebas para FEAT-018 US-0068: Endpoint Crear Solicitud

@baseUrl = http://localhost:3000
@contentType = application/json

### ===========================================
### 1. SOLICITUDES VÁLIDAS
### ===========================================

### 1.1 Crear solicitud válida (Debe retornar 201)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a2",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a3",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a4",
  "reason": "Conflicto de horario con trabajo",
  "observations": "Necesito cambiar por motivos laborales"
}

### 1.2 Solicitud duplicada - mismo día (Debe retornar 200 con solicitud existente)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a2",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a3",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a4",
  "reason": "Mismo cambio del ejemplo anterior"
}

### ===========================================
### 2. VALIDACIONES DE DATOS
### ===========================================

### 2.1 Materia origen = materia destino (Debe retornar 400)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a2",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a4"
}

### 2.2 Campos obligatorios faltantes (Debe retornar 422)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a3"
}

### 2.3 IDs inválidos (Debe retornar 422)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "invalid-id",
  "sourceGroupId": "also-invalid",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a3",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a4"
}

### 2.4 Observaciones muy largas (Debe retornar 422)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a1",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a2",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a3",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a4",
  "observations": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo."
}

### ===========================================
### 3. SANITIZACIÓN DE OBSERVACIONES
### ===========================================

### 3.1 Observaciones con HTML peligroso (Se sanitiza)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a5",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1a6",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1a7",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1a8",
  "observations": "<script>alert('hack')</script>Solicitud <b>urgente</b> de cambio"
}

### 3.2 Observaciones vacías (Se convierte a null)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1a9",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1aa",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1ab",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1ac",
  "observations": ""
}

### ===========================================
### 4. CONSULTAS DE SOLICITUDES
### ===========================================

### 4.1 Obtener solicitudes de usuario
GET {{baseUrl}}/change-request-examples/user/example-user-123

### 4.2 Obtener solicitud específica por ID
GET {{baseUrl}}/change-request-examples/60d5ecb8b0a7c4b4b8b9b1a4

### 4.3 Obtener solicitud inexistente (Debe retornar 400)
GET {{baseUrl}}/change-request-examples/60d5ecb8b0a7c4b4b8b9b999

### ===========================================
### 5. PRUEBAS DE SISTEMA ANTI-DUPLICADOS
### ===========================================

### 5.1 Primera solicitud del día
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1b1",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1b2",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1b3",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1b4",
  "reason": "Primera solicitud"
}

### 5.2 Solicitud duplicada exacta (Debe retornar la existente)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1b1",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1b2",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1b3",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1b4",
  "reason": "Solicitud duplicada - debe retornar la existente"
}

### 5.3 Solicitud diferente (grupos diferentes - debe crear nueva)
POST {{baseUrl}}/change-request-examples
Content-Type: {{contentType}}

{
  "sourceSubjectId": "60d5ecb8b0a7c4b4b8b9b1b1",
  "sourceGroupId": "60d5ecb8b0a7c4b4b8b9b1b2",
  "targetSubjectId": "60d5ecb8b0a7c4b4b8b9b1b5",
  "targetGroupId": "60d5ecb8b0a7c4b4b8b9b1b6",
  "reason": "Solicitud diferente - debe crear nueva"
}

### ===========================================
### NOTAS DE PRUEBA:
### 
### Criterios de aceptación verificados:
### ✅ Solicitud válida se crea y devuelve 201
### ✅ Duplicado devuelve solicitud existente (200)
### ✅ Validaciones rechazan datos inválidos (422)
### ✅ Se registra en auditoría correctamente
### ✅ Response incluye ID de solicitud creada
### 
### Sistema anti-duplicados:
### - Hash basado en: userId + sourceSubject + targetSubject + fecha
### - Permite nueva solicitud en diferente día
### - Evita duplicados por doble clic/refresh
### 
### Validaciones implementadas:
### - Campos obligatorios
### - Formato de ObjectIds
### - Origen ≠ destino
### - Longitud de observaciones
### - Sanitización de HTML
### ===========================================